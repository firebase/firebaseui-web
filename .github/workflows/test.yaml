name: Test

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          check-latest: true
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
      - name: Install dependencies
        run: pnpm install
      - name: Run ESLint on core packages
        run: pnpm --filter=@firebase-ui/core run lint && pnpm --filter=@firebase-ui/react run lint && pnpm --filter=@firebase-ui/translations run lint && pnpm --filter=@firebase-ui/styles run lint
      - name: Check Prettier formatting
        run: pnpm format:check

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          check-latest: true
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
      - name: Install dependencies
        run: pnpm install
      - name: Install Firebase CLI
        run: npm i -g firebase-tools@14.15.2
      - name: Start Firebase emulator and run tests
        run: |
          firebase emulators:start --only auth --project demo-test &
          sleep 15
          # Wait for emulator to be ready
          until wget -q --spider http://localhost:9099 2>/dev/null; do
            echo "Waiting for emulator to start..."
            sleep 2
          done
          echo "Emulator is ready, running tests..."
          pnpm test
